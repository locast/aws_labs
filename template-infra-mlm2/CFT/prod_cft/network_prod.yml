AWSTemplateFormatVersion: 2010-09-09

Description: "Production network"

Parameters:  
  PUBLIC-SUBNET-PRODCdir:
    Type: String

  LB-SUBNET-PRODCdir:
    Type: String

  PRIVATE-SUBNET-PRODCdir: 
    Type: String

Resources: 

  VPC-PROD:
    Type: 'AWS::EC2::VPC'
    Properties:
      CidrBlock: 172.30.0.0/24
      Tags:
        - Key: Name
          Value: VPC-PROD-mlm

  EIP-PROD:
    Type: 'AWS::EC2::EIP'
    DependsOn: PUBLIC-SUBNET-PROD

  PUBLIC-SUBNET-PROD:
    Type: 'AWS::EC2::Subnet'
    Properties:
      VpcId: !Ref VPC-PROD
      AvailabilityZone: us-east-1a
      CidrBlock: !Ref PUBLIC-SUBNET-PRODCdir
      Tags:
        - Key: Name
          Value: PUBLIC-SUBNET-PROD-mlm
    DependsOn: VPC-PROD

  LB-SUBNET-PROD:
    Type: 'AWS::EC2::Subnet'
    Properties:
      VpcId: !Ref VPC-PROD
      AvailabilityZone: us-east-1b
      CidrBlock: !Ref LB-SUBNET-PRODCdir
      Tags:
        - Key: Name
          Value: LB-SUBNET-PROD-mlm
    DependsOn: VPC-PROD

  PRIVATE-SUBNET-PROD:
    Type: 'AWS::EC2::Subnet'
    Properties:
      VpcId: !Ref VPC-PROD
      #AvailabilityZone: us-east-1b
      CidrBlock: !Ref PRIVATE-SUBNET-PRODCdir
      Tags:
        - Key: Name
          Value: PRIVATE-SUBNET-PROD-mlm

  IGW-PROD:
    Type: 'AWS::EC2::InternetGateway'
    Properties:
      Tags:
        - Key: Name
          Value: IGW-PROD-mlm
    DependsOn: VPC-PROD

  NATGW-PROD:
    Type: 'AWS::EC2::NatGateway'
    Properties:
      AllocationId: !GetAtt 
        - EIP-PROD
        - AllocationId
      SubnetId: !Ref PUBLIC-SUBNET-PROD
      Tags:
        - Key: Name
          Value: NATGW-PROD-mlm
    DependsOn: EIP-PROD

  VPC-GWATTACHMENT-PROD:
    Type: 'AWS::EC2::VPCGatewayAttachment'
    Properties:
      InternetGatewayId: !Ref IGW-PROD
      VpcId: !Ref VPC-PROD

  PUBLIC-RT-PROD:
    Type: 'AWS::EC2::RouteTable'
    Properties:
      VpcId: !Ref VPC-PROD
      Tags:
        - Key: Name
          Value: PUBLIC-RT-PROD-mlm

  LB-RT-PROD:
    Type: 'AWS::EC2::RouteTable'
    Properties:
      VpcId: !Ref VPC-PROD
      Tags:
        - Key: Name
          Value: LB-RT-PROD-mlm

  PRIVATE-RT-PROD:
    Type: 'AWS::EC2::RouteTable'
    Properties:
      VpcId: !Ref VPC-PROD
      Tags:
        - Key: Name
          Value: PRIVATE-RT-PROD-mlm

  PUBLIC-ROUTE-PROD:
    Type: 'AWS::EC2::Route'
    Properties:
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref IGW-PROD
      RouteTableId: !Ref PUBLIC-RT-PROD

  LB-ROUTE-PROD:
    Type: 'AWS::EC2::Route'
    Properties:
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref IGW-PROD
      RouteTableId: !Ref LB-RT-PROD

  PRIVATE-ROUTE-PROD:
    Type: 'AWS::EC2::Route'
    Properties:
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NATGW-PROD
      RouteTableId: !Ref PRIVATE-RT-PROD

  PUBLIC-SUBNET-RTASSOCIATION-PROD:
    Type: 'AWS::EC2::SubnetRouteTableAssociation'
    Properties:
      RouteTableId: !Ref PUBLIC-RT-PROD
      SubnetId: !Ref PUBLIC-SUBNET-PROD
    DependsOn: PUBLIC-RT-PROD

  LB-SUBNET-RTASSOCIATION-PROD:
    Type: 'AWS::EC2::SubnetRouteTableAssociation'
    Properties:
      RouteTableId: !Ref LB-RT-PROD
      SubnetId: !Ref LB-SUBNET-PROD
    DependsOn: LB-RT-PROD

  PRIVATE-SUBNET-RTASSOCIATION-PROD:
    Type: 'AWS::EC2::SubnetRouteTableAssociation'
    Properties:
      RouteTableId: !Ref PRIVATE-RT-PROD
      SubnetId: !Ref PRIVATE-SUBNET-PROD
    DependsOn: PRIVATE-RT-PROD

  PUBLIC-SG-PROD:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupName: PUBLIC-SG-PROD-mlm
      GroupDescription: PUBLIC SG rules for prod
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0
      VpcId: !Ref VPC-PROD
      Tags:
        - Key: Name
          Value: PUBLIC-SG-PROD-mlm

  PRIVATE-SG-PROD:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupName: PRIVATE-SG-PROD-mlm
      GroupDescription: PRIVATE SG rules for prod
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 12376
          ToPort: 12388
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 10250
          ToPort: 10250
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 9099
          ToPort: 9099
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 7946
          ToPort: 7946
          CidrIp: 0.0.0.0/0
        - IpProtocol: udp
          FromPort: 7946
          ToPort: 7946
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 6443
          ToPort: 6444
          CidrIp: 0.0.0.0/0
        - IpProtocol: udp
          FromPort: 4789
          ToPort: 4789
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 2376
          ToPort: 2377
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 179
          ToPort: 179
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0
      VpcId: !Ref VPC-PROD
      Tags:
        - Key: Name
          Value: PRIVATE-SG-PROD-mlm

  LB-SG-PROD:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: LB-SG-PROD-mlm
      GroupDescription: LB SG rules for prod
      SecurityGroupIngress:
      - IpProtocol: "tcp"
        FromPort: 80
        ToPort: 80
        CidrIp: 0.0.0.0/0
      - IpProtocol: "tcp"
        FromPort: 443
        ToPort: 443
        CidrIp: 0.0.0.0/0
      VpcId: !Ref VPC-PROD
      Tags: 
        -
          Key: Name
          Value: LB-SG-PROD-mlm

Outputs:

  VPC-ID-PROD:
    Description: VPC ID for prod
    Value: !Ref VPC-PROD
    Export:
      Name: !Sub VPC-ID-PROD-mlm

  PUBLIC-SUBNET-ID-PROD:
    Description: PUBLIC SUBNET ID for public web servers
    Value: !Ref PUBLIC-SUBNET-PROD
    Export:
      Name: !Sub PUBLIC-SUBNET-ID-PROD-mlm

  LB-ID-PROD:
    Description: LB SUBNET ID for public web servers
    Value: !Ref LB-SUBNET-PROD
    Export:
      Name: !Sub LB-ID-PROD-mlm

  PRIVATE-SUBNET-ID-PROD:
    Description: PRIVATE SUBNET ID for public web servers
    Value: !Ref PRIVATE-SUBNET-PROD
    Export:
      Name: !Sub PRIVATE-SUBNET-ID-PROD-mlm

  PUBLIC-SG-ID-PROD:
    Description: PUBLIC SG ID for public web servers
    Value: !GetAtt 
      - PUBLIC-SG-PROD
      - GroupId
    Export:
      Name: !Sub PUBLIC-SG-ID-PROD-mlm
  
  LB-SG-ID-PROD:
    Description: LB SG ID for public web servers
    Value: !GetAtt 
      - LB-SG-PROD
      - GroupId
    Export:
      Name: !Sub LB-SG-ID-PROD-mlm

  PRIVATE-SG-ID-PROD:
    Description: PRIVATE SG ID for public web servers
    Value: !GetAtt 
      - PRIVATE-SG-PROD
      - GroupId
    Export:
      Name: !Sub PRIVATE-SG-ID-PROD-mlm
