from __future__ import print_function
import json
import boto3
import logging
import time
import datetime
##################
debug=True

target_tag = 'docker_aws_mlm'
inventory_groups = ['manager', 'worker', 'DTR', 'Jenkins', 'gitlab']

inventory_s3_url = ""
##################
logger = logging.getLogger()
logger.setLevel(logging.INFO)

def lambda_handler(event, context):
    ids = []

    if debug:
        logger.info('event: ' + str(event))

    try:
        region = event['region']
        instance_id = event['detail']['instance-id']
    except Exception as error:    
        logger.error('principalId: ' + str(error))
    
    ec2 = boto3.resource('ec2')
    try:
        instance = ec2.Instance('instance_id')
        instance_tags = instance.tags
        instance_private_ip = instance.private_ip_address

        #instance_sshkey_name = instance.private_ip_address

    except Exception as error:
        logger.error('error: ' + str(error))
    if debug:
        logger.info('tags: ' + str(instance_tags))
        logger.info('PIp: ' + str(instance_private_ip))

    if target_tag in instance_tags:
        inventory_line = instance_private_ip
        with open(s3_inventory) as inventory:
            


instance_ip='10.0.0.0'
instance_tags = { 'trg':'mlm' , 'fn':'manager'}
inventory_link='inventory2.txt'
instance_sshkey='devopsKey'
instance_user= 'ubuntu'


def inventory_update(instance_ip, instance_tags, instance_sshkey, instance_user, inventory_link):
    #if target tag present
        fn = instance_tags['fn']
        ansible_grp = '['+fn+']\n'
        with open(inventory_link,'r') as inventory_file:
            inventory = inventory_file.readlines()
            print(inventory)
        print(inventory)

        line = '{0} ansible_ssh_user={1} ansible_ssh_key={2}\n'.format(instance_ip, instance_user, instance_sshkey)

        if ansible_grp in inventory:
            index = inventory.index(ansible_grp)

            index = insert = index + 1
            present = False
            file_line = inventory[index]
            print(index)
            while file_line[0] != '[' and index < len(inventory):
                file_line = inventory[index]
                print(file_line)
                if file_line.split(' ')[0] == instance_ip:
                    print(instance_ip, file_line.split(' '))
                    present = True
                index += 1
            print(present)
            if not present:
                inventory.insert(insert, line)
        else:
            inventory.append(ansible_grp)
            inventory.append(line)


        print(inventory)
        with open('inventory2.txt','w') as inventory_file:
            inventory = inventory_file.writelines(inventory)
